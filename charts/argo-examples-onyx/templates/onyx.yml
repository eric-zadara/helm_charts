{{ $chartName := "onyx" }}
{{ $helmRepo := "https://zadarastorage.github.io/helm-charts" }}
{{ $gitRepo := "https://github.com/zadarastorage/helm-charts.git" }}
{{ $chartPath := "charts/onyx" }}
{{ $appConfig := merge (index $.Values $chartName) $.Values.common }}
{{- if ne $appConfig.enabled false }}
{{ $argoConfig := merge (default $appConfig.argocdApps (dict)) $.Values.argocdApps }}
{{ $appName := default $chartName $appConfig.nameOverride }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $appName }}
  namespace: {{ $argoConfig.namespace }}
  annotations: {{ toYaml $argoConfig.annotations | nindent 4 }}
spec:
  project: {{ $argoConfig.project }}
  destination:
    namespace: {{ default $appName $appConfig.namespace }}
    server: {{ $argoConfig.destination.server }}
  syncPolicy: {{ toYaml $argoConfig.syncPolicy | nindent 4 }}
  source:
{{- if eq $appConfig.chartSource "helm" }}
    repoURL: {{ $helmRepo }}
    chart: {{ $chartName }}
{{- else if eq $appConfig.chartSource "git" }}
    repoURL: {{ $gitRepo }}
    path: {{ $chartPath }}
{{- end }}
    targetRevision: {{ $appConfig.targetRevision }}
    helm:
      valuesObject:
{{- if $appConfig.helmConfig }}
{{ toYaml $appConfig.helmConfig | indent 8 }}
{{- else }}
        cnpg:
          cluster:
            instances: {{ $appConfig.redundancy.replicas }}
            monitoring:
              enabled: {{ (default false $appConfig.monitoring.enabled) }}
          pooler:
            instances: {{ $appConfig.redundancy.replicas }}
            monitoring:
              enabled: {{ (default false $appConfig.monitoring.enabled) }}
        vespa:
          statefulSets:
            single: { enabled: false }
            cfg:
              enabled: true
              replicaCount: {{ $appConfig.redundancy.replicas }}
            content:
              enabled: true
              replicaCount: {{ $appConfig.redundancy.replicas }}
          replicaCount: {{ $appConfig.redundancy.replicas }}
        configMap:
          vespa:
            VESPA_CONFIG_SERVER_HOST: 'vespa-cfg'
            VESPA_HOST: 'vespa-content'
        hotpatch:
          vespaRedundancy: {{ (div $appConfig.redundancy.replicas 2) | add1 }}
        web:
          replicaCount: {{ $appConfig.redundancy.replicas }}
        api:
          replicaCount: 1
        worker:
          replicaCount: 1
        {{- range $i, $section := (list "inference" "index") }}
        {{ $section }}:
          replicaCount: 1
          runtimeClassName: nvidia
          resources:
            requests:
              nvidia.com/gpu: 4
            limits:
              nvidia.com/gpu: 4
          tolerations:
            - key: nvidia.com/gpu
              operator: Exists
              effect: NoSchedule
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - key: nvidia.com/device-plugin.config
                    operator: In
                    values:
                      - tesla-25b6
                      - tesla-2235
                      - tesla-27b8
                      - tesla-26b9
        {{- end }}
        ingress:
          enabled: {{ default false $appConfig.ingress.enabled }}
          {{- if default false $appConfig.ingress.enabled }}
          annotations:
            cert-manager.io/cluster-issuer: self-signed
          tls: true
          {{- if not (not $appConfig.ingress.rootDomain) }}
          hostname: "onyx.{{ $appConfig.ingress.rootDomain }}"
          {{- end }}
          {{- end }}
{{- end }}
{{- end }}
