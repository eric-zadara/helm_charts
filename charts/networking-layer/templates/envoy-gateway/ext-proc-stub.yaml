{{- if and (index .Values "envoy-gateway").enabled .Values.extProc.stub }}
#
# EnvoyExtensionPolicy Stub for Phase 7 (Inference Gateway)
#
# This placeholder demonstrates ext-proc capability. Phase 7 will create
# the actual EnvoyExtensionPolicy targeting specific HTTPRoutes with the
# Inference Gateway (EPP) service as the ext-proc backend.
#
# Traffic flow (completed in Phase 7):
# NLB -> Envoy Gateway -> LiteLLM -> EPP (ext-proc) -> Kourier -> KServe -> Runtime
#
# The actual EnvoyExtensionPolicy will specify:
# - targetRefs: HTTPRoute(s) that need KV-cache aware routing
# - extProc.backendRefs: Inference Gateway gRPC service
# - processingMode: Request headers for routing decisions
#
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: {{ include "networking-layer.fullname" . }}-ext-proc-stub
  labels:
    {{- include "networking-layer.labels" . | nindent 4 }}
  annotations:
    # Keep this stub so it's not deleted on helm upgrade
    helm.sh/resource-policy: keep
    # Mark as placeholder for Phase 7
    llm-platform.io/phase: "7-inference-gateway"
    llm-platform.io/status: "stub"
spec:
  # Target a placeholder - Phase 7 will create the real policy
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: placeholder-for-phase-7
  # ext-proc configuration will be added by Phase 7
  # extProc:
  #   - backendRefs:
  #       - name: inference-gateway
  #         port: 9002
  #     processingMode:
  #       request: {}
{{- end }}
