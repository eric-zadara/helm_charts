{{- $fullName := include "networking-layer.fullname" . -}}
{{- $gatewayName := include "networking-layer.gatewayName" . -}}
{{- $gatewayClassName := include "networking-layer.gatewayClassName" . -}}

=======================================================================
 LLM Inference Platform - Networking Layer
=======================================================================

{{- if (index .Values "envoy-gateway").enabled }}

ENVOY GATEWAY
-------------

The Envoy Gateway controller has been deployed. To verify:

  # Check Envoy Gateway pods
  kubectl get pods -n envoy-gateway-system

  # Check GatewayClass status
  kubectl get gatewayclass {{ $gatewayClassName }}

  # Check Gateway status
  kubectl get gateway {{ $gatewayName }} -n {{ .Release.Namespace }}

  # Get external IP/hostname (may take a few minutes)
  kubectl get svc -n envoy-gateway-system -l gateway.envoyproxy.io/owning-gateway-name={{ $gatewayName }}

LoadBalancer Verification:
  AWS NLB provisioning typically takes 2-5 minutes. Monitor status:

  # Check LoadBalancer status (EXTERNAL-IP should change from <pending>)
  kubectl get svc -n envoy-gateway-system -w

  # If LoadBalancer stays pending, check:
  # 1. AWS Load Balancer Controller is installed and running
  # 2. Service annotations are correct for your environment
  # 3. Security groups allow inbound traffic on ports 80/443
  # 4. Subnets are tagged correctly for auto-discovery

  # Verify endpoint is reachable
  GATEWAY_IP=$(kubectl get svc -n envoy-gateway-system -l gateway.envoyproxy.io/owning-gateway-name={{ $gatewayName }} -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
  curl -v http://$GATEWAY_IP/

{{- if .Values.tls.enabled }}

TLS Configuration:
  - TLS termination: ENABLED
  - Certificate secret: {{ .Values.tls.secretName | default (printf "%s-tls" $fullName) }}
  {{- if .Values.tls.certManager.enabled }}
  - cert-manager: ENABLED (ClusterIssuer: {{ .Values.tls.certManager.clusterIssuer }})

  # Check certificate status
  kubectl get certificate {{ $fullName }}-tls -n {{ .Release.Namespace }}
  kubectl describe certificate {{ $fullName }}-tls -n {{ .Release.Namespace }}
  {{- else }}
  - cert-manager: DISABLED (using existing secret)
  {{- end }}
{{- else }}

TLS Configuration:
  - TLS termination: DISABLED (HTTP only)
{{- end }}

{{- else }}

ENVOY GATEWAY: DISABLED
-----------------------

Using external Gateway:
{{- if (index .Values "envoy-gateway").external.name }}
  - Gateway: {{ (index .Values "envoy-gateway").external.namespace }}/{{ (index .Values "envoy-gateway").external.name }}
  - GatewayClass: {{ (index .Values "envoy-gateway").external.gatewayClassName }}
{{- else }}
  - No external Gateway configured - skipping Gateway API resources
{{- end }}

{{- end }}

{{- if .Values.kourier.enabled }}

KOURIER (Knative Networking)
----------------------------

Kourier has been deployed for Knative internal networking. To verify:

  # Check Kourier pods
  kubectl get pods -n kourier-system

  # Check Kourier services
  kubectl get svc -n kourier-system

  # Verify Knative is using Kourier
  kubectl get configmap config-network -n knative-serving -o jsonpath='{.data.ingress-class}'
  # Should output: kourier.ingress.networking.knative.dev

NOTE: Kourier service is ClusterIP (internal-only). External traffic should
flow through Envoy Gateway, not directly to Kourier.

{{- else }}

KOURIER: DISABLED
-----------------

{{- if .Values.kourier.external.serviceName }}
Using external Kourier:
  - Service: {{ .Values.kourier.external.namespace }}/{{ .Values.kourier.external.serviceName }}
{{- else }}
Knative networking is expected to be provided by the environment.
Ensure an ingress controller is configured in knative-serving/config-network.
{{- end }}

{{- end }}

{{- if .Values.extProc.stub }}

EXT-PROC STUB (Phase 7 Preparation)
-----------------------------------

An EnvoyExtensionPolicy stub has been created for Phase 7 (Inference Gateway):

  kubectl get envoyextensionpolicy {{ $fullName }}-ext-proc-stub -n {{ .Release.Namespace }}

This is a placeholder. Phase 7 will configure the actual ext-proc policy
for KV-cache aware routing via the Inference Gateway (EPP).

Ext-proc Capability:
  Envoy Gateway v1.6.2 enables ext-proc API by default. No explicit configuration
  is required to enable external processing support. The EnvoyExtensionPolicy CRD
  (gateway.envoyproxy.io/v1alpha1) is available for defining ext-proc backends.

  # Verify ext-proc CRD is available
  kubectl get crd envoyextensionpolicies.gateway.envoyproxy.io

  Phase 7 will create the actual policy targeting HTTPRoutes with the
  Inference Gateway gRPC service as the ext-proc backend.

{{- end }}

TRAFFIC FLOW
------------

{{- if and (index .Values "envoy-gateway").enabled .Values.kourier.enabled }}
Full traffic path (completed in later phases):

  Internet -> NLB -> Envoy Gateway -> LiteLLM (Phase 6)
                  -> Inference Gateway/EPP (Phase 7)
                  -> Kourier -> KServe (Phase 5) -> Runtime

Current phase establishes: NLB -> Envoy Gateway and Kourier (internal)
{{- else }}
Partial networking stack deployed. Full traffic flow requires both
Envoy Gateway and Kourier to be enabled.
{{- end }}

NEXT STEPS
----------

1. Verify Gateway has external IP:
   kubectl get gateway {{ $gatewayName }} -n {{ .Release.Namespace }} -o jsonpath='{.status.addresses[0].value}'

2. Test HTTP connectivity (once LoadBalancer is ready):
   curl -v http://<GATEWAY_IP>/

3. Proceed to Phase 5 (Basic Model Serving) to deploy KServe/vLLM

=======================================================================
