{{- if .Values.knative.enabled }}
# Knative KPA autoscaler defaults tuned for LLM inference workloads
# These settings apply cluster-wide to all Knative Services (including KServe InferenceServices)
# Per-InferenceService overrides via annotations take precedence
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-autoscaler
  namespace: knative-serving
  labels:
    {{- include "networking-layer.labels" . | nindent 4 }}
    app.kubernetes.io/component: autoscaler
data:
  # Enable scale-to-zero (required for SCALE-01)
  enable-scale-to-zero: {{ .Values.knative.autoscaler.enableScaleToZero | quote }}

  # Time before last pod is removed after scale-to-zero decision
  # Allows network programming to complete gracefully
  scale-to-zero-grace-period: {{ .Values.knative.autoscaler.scaleToZeroGracePeriod | quote }}

  # Minimum time last pod stays after autoscaler decides to scale to zero
  # Increased from 0s default to accommodate GPU node autoscaler delays
  scale-to-zero-pod-retention-period: {{ .Values.knative.autoscaler.scaleToZeroPodRetentionPeriod | quote }}

  # Time window for averaging concurrency (stable window)
  # 60s is appropriate for LLM workloads with variable request durations
  stable-window: {{ .Values.knative.autoscaler.stableWindow | quote }}

  # Delay before applying scale-down decision
  # 5 minutes (300s) prevents flapping and accommodates LLM cold start costs
  scale-down-delay: {{ .Values.knative.autoscaler.scaleDownDelay | quote }}

  # Default minimum replicas (0 enables scale-to-zero)
  min-scale: {{ .Values.knative.autoscaler.minScale | quote }}

  # Maximum rate for scaling up (conservative for GPU workloads)
  max-scale-up-rate: {{ .Values.knative.autoscaler.maxScaleUpRate | quote }}

  # Maximum rate for scaling down (slow to avoid premature termination)
  max-scale-down-rate: {{ .Values.knative.autoscaler.maxScaleDownRate | quote }}

  # Default concurrency target per pod (soft limit)
  container-concurrency-target-default: {{ .Values.knative.autoscaler.containerConcurrencyTargetDefault | quote }}

  # Target utilization percentage before scaling
  container-concurrency-target-percentage: {{ .Values.knative.autoscaler.containerConcurrencyTargetPercentage | quote }}
{{- end }}
