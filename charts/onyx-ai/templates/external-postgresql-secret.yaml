{{/*
External PostgreSQL Secret
Only created when:
1. cnpg.enabled is false (using external PostgreSQL)
2. externalPostgresql.existingSecret is not set (no pre-existing secret)
3. externalPostgresql.username and password are provided

This secret is referenced by onyx-ai.postgresql.secretName helper.
*/}}
{{- if not .Values.cnpg.enabled }}
{{- if not .Values.externalPostgresql.existingSecret }}
{{- if and .Values.externalPostgresql.username .Values.externalPostgresql.password }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "onyx-ai.fullname" . }}-external-postgresql
  labels:
    {{- include "onyx-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
stringData:
  # Keys match CNPG app secret format for consistency
  username: {{ .Values.externalPostgresql.username | quote }}
  password: {{ .Values.externalPostgresql.password | quote }}
  host: {{ .Values.externalPostgresql.host | quote }}
  port: {{ .Values.externalPostgresql.port | default 5432 | quote }}
  dbname: {{ .Values.externalPostgresql.database | default "postgres" | quote }}
  # Connection URI for applications that support it
  uri: {{ printf "postgresql://%s:%s@%s:%d/%s"
    .Values.externalPostgresql.username
    .Values.externalPostgresql.password
    .Values.externalPostgresql.host
    (int (.Values.externalPostgresql.port | default 5432))
    (.Values.externalPostgresql.database | default "postgres") | quote }}
{{- end }}
{{- end }}
{{- end }}
