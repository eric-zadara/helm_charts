{{/*
External Object Storage Secret
==============================
This Secret is created ONLY when ALL of the following are true:
  1. useIAM is false (not using IAM role authentication)
  2. existingSecret is NOT set (no pre-existing secret provided)
  3. accessKey IS set (inline credentials provided)

The secret keys match upstream Onyx auth.objectstorage pattern:
  - s3_aws_access_key_id: S3 access key
  - s3_aws_secret_access_key: S3 secret key

When this secret is created:
  - Name: {fullname}-external-objectstorage
  - Users must set onyx.auth.objectstorage.existingSecret to this name
  - See NOTES.txt output after helm install for instructions
*/}}
{{- if not .Values.objectStorage.useIAM }}
{{- if not .Values.objectStorage.existingSecret }}
{{- if .Values.objectStorage.accessKey }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "onyx-ai.fullname" . }}-external-objectstorage
  labels:
    {{- include "onyx-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: objectstorage
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
type: Opaque
stringData:
  # Keys match upstream auth.objectstorage.secretKeys pattern
  # These get injected to pods via onyx.envSecrets helper
  s3_aws_access_key_id: {{ .Values.objectStorage.accessKey | quote }}
  s3_aws_secret_access_key: {{ .Values.objectStorage.secretKey | quote }}
{{- end }}
{{- end }}
{{- end }}
