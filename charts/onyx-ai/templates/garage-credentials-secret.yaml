{{/*
GarageFS Credentials Secret
===========================
Auto-generates S3 credentials for GarageFS when garage.enabled: true.
Uses Helm lookup to persist credentials across upgrades.

Pattern: Same as redis-ha-secret.yaml lookup pattern.

The secret provides:
- Onyx-compatible keys: s3_aws_access_key_id, s3_aws_secret_access_key
- Garage-compatible keys: garage_access_key_id, garage_secret_access_key

This secret is referenced by:
- onyx-ai.objectStorage.secretName helper (returns this name for GarageFS mode)
- onyx.auth.objectstorage.existingSecret (wires to Onyx pods)
*/}}
{{- if .Values.garage.enabled }}
{{- $secretName := printf "%s-garage-credentials" (include "onyx-ai.fullname" .) -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $accessKey := "" -}}
{{- $secretKey := "" -}}
{{- if $existingSecret -}}
  {{- /* Reuse existing credentials from previous install/upgrade */ -}}
  {{- $accessKey = index $existingSecret.data "s3_aws_access_key_id" | b64dec -}}
  {{- $secretKey = index $existingSecret.data "s3_aws_secret_access_key" | b64dec -}}
{{- else -}}
  {{- /* Generate new credentials on first install */ -}}
  {{- /* GarageFS keyId format: GK + 24 hex chars; secretKey: 64 hex chars */ -}}
  {{- $accessKey = .Values.garage.accessKey | default (printf "GK%s" (uuidv4 | replace "-" "" | trunc 24 | upper)) -}}
  {{- $secretKey = .Values.garage.secretKey | default (printf "%s%s" (uuidv4 | replace "-" "") (uuidv4 | replace "-" "") | trunc 64) -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "onyx-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: garage-credentials
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
type: Opaque
stringData:
  # Keys match upstream Onyx pattern for S3 credentials
  s3_aws_access_key_id: {{ $accessKey | quote }}
  s3_aws_secret_access_key: {{ $secretKey | quote }}
  # Also provide garage-specific keys for the subchart
  garage_access_key_id: {{ $accessKey | quote }}
  garage_secret_access_key: {{ $secretKey | quote }}
{{- end }}
