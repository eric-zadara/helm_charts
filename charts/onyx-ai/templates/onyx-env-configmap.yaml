{{/*
Onyx Environment ConfigMap
==========================
This ConfigMap OVERRIDES the upstream onyx chart's configmap.yaml.
It includes all upstream values PLUS our object storage configuration.

File name: onyx-env-configmap.yaml (our template)
ConfigMap name: env-configmap (metadata.name)

By using the same metadata.name (env-configmap), Helm uses our version.
This is not a conflict - Helm parent charts take precedence over dependency
chart templates when they produce resources with the same name.

All Onyx pods read this via envFrom.configMapRef in their deployment specs.
*/}}
{{- include "onyx-ai.objectStorage.validate" . }}
{{- include "onyx-ai.redis.validate" . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-configmap
  labels:
    {{- include "onyx-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: env-config
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
data:
  # ============================================================================
  # Upstream Onyx values (replicated from upstream configmap.yaml)
  # ============================================================================
  INTERNAL_URL: "http://{{ include "onyx-ai.fullname" . }}-onyx-api-service:{{ .Values.onyx.api.service.port | default 8080 }}"
  {{- if .Values.onyx.vespa.enabled }}
  VESPA_HOST: {{ .Values.onyx.vespa.name | default "vespa" }}.{{ .Values.onyx.vespa.service.name | default "vespa" }}.{{ .Release.Namespace }}.svc.cluster.local
  {{- end }}
  {{- if .Values.onyx.opensearch.enabled }}
  OPENSEARCH_HOST: {{ .Values.onyx.opensearch.clusterName }}-{{ .Values.onyx.opensearch.nodeGroup }}.{{ .Release.Namespace }}.svc.cluster.local
  OPENSEARCH_REST_API_PORT: "9200"
  ENABLE_OPENSEARCH_INDEXING_FOR_ONYX: "true"
  ENABLE_OPENSEARCH_RETRIEVAL_FOR_ONYX: "false"
  {{- end }}
  MODEL_SERVER_HOST: "{{ include "onyx-ai.fullname" . }}-onyx-inference-model-service"
  INDEXING_MODEL_SERVER_HOST: "{{ include "onyx-ai.fullname" . }}-onyx-indexing-model-service"
  {{- range $key, $value := .Values.onyx.configMap }}
  {{- if and (not (empty $value)) (not (hasPrefix "S3_" $key)) (ne $key "AWS_REGION_NAME") }}
  {{ $key }}: {{ $value | quote }}
  {{- end }}
  {{- end }}
  # ============================================================================
  # Object Storage Configuration (Phase 5)
  # ============================================================================
  {{- $endpoint := include "onyx-ai.objectStorage.endpoint" . }}
  {{- if $endpoint }}
  S3_ENDPOINT_URL: {{ $endpoint | quote }}
  {{- end }}
  S3_FILE_STORE_BUCKET_NAME: {{ include "onyx-ai.objectStorage.bucket" . | quote }}
  S3_FILE_STORE_PREFIX: {{ include "onyx-ai.objectStorage.prefix" . | quote }}
  {{- $region := include "onyx-ai.objectStorage.region" . }}
  {{- if $region }}
  AWS_REGION_NAME: {{ $region | quote }}
  {{- end }}
  S3_VERIFY_SSL: {{ include "onyx-ai.objectStorage.sslVerify" . | quote }}
  # ============================================================================
  # PostgreSQL Configuration (Phase 8.1 - merged from postgres-config)
  # ============================================================================
  POSTGRES_HOST: {{ include "onyx-ai.postgresql.host" . | quote }}
  POSTGRES_PORT: {{ include "onyx-ai.postgresql.port" . | quote }}
  {{- if not .Values.cnpg.enabled }}
  POSTGRES_DB: {{ .Values.externalPostgresql.database | default "postgres" | quote }}
  {{- end }}
  # ============================================================================
  # Redis Configuration (Phase 8.1 - merged from redis-config)
  # ============================================================================
  REDIS_HOST: {{ include "onyx-ai.redis.host" . | quote }}
  REDIS_PORT: {{ include "onyx-ai.redis.port" . | quote }}
  {{- $dbNum := include "onyx-ai.redis.database" . -}}
  {{- if ne $dbNum "0" }}
  REDIS_DB_NUMBER: {{ $dbNum | quote }}
  {{- end }}
  {{- if eq (include "onyx-ai.redis.tlsEnabled" .) "true" }}
  REDIS_SSL: "true"
  {{- end }}
  {{- if .Values.onyx.codeInterpreter.enabled }}
  CODE_INTERPRETER_BASE_URL: "http://{{ .Release.Name }}-code-interpreter:{{ .Values.onyx.codeInterpreter.service.port }}"
  {{- end }}
