{{/*
Redis HA Password Secret

This Secret provides the password for Spotahome Redis HA mode.
Created ONLY when redis.ha.enabled: true.

Password generation strategy:
- Use lookup to check for existing secret (persists across upgrades)
- If no existing secret, generate new random password
- If existing secret found, reuse the password

The secret key 'redis_password' is used for HA and external Redis modes.
(Default Valkey mode uses 'valkey-password' from the Bitnami chart secret.)

This secret is referenced by:
- RedisFailover CRD (redis-ha-redisfailover.yaml)
- onyx-ai.redis.secretName helper (returns this name for HA mode)
*/}}
{{- if .Values.redis.ha.enabled }}
{{- $secretName := printf "%s-redis-ha" (include "onyx-ai.fullname" .) -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $password := "" -}}
{{- if $existingSecret -}}
  {{- /* Reuse existing password to prevent rotation on upgrade */ -}}
  {{- $password = index $existingSecret.data "redis_password" | b64dec -}}
{{- else -}}
  {{- /* Generate new secure password (32 chars alphanumeric) */ -}}
  {{- $password = randAlphaNum 32 -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "onyx-ai.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
type: Opaque
stringData:
  # Key: redis_password (HA mode convention)
  redis_password: {{ $password | quote }}
{{- end }}
