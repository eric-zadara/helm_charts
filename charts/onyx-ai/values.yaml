# onyx-ai values
# Convenience Helm chart wrapping Onyx with HA defaults
#
# Values under `onyx:` are passed directly to the upstream Onyx chart.
# See: https://github.com/onyx-dot-app/onyx/blob/main/deployment/helm/charts/onyx/values.yaml
#
# IMPORTANT: Upstream uses aliases in Chart.yaml:
#   - `postgresql:` (not `cloudnative-pg:`) for the CNPG cluster
#   - `nginx:` (not `ingress-nginx:`) for the ingress controller
# Always use the alias names when overriding subchart values.

# ------------------------------------------------------------------------------
# Convenience Chart Values (onyx-ai specific)
# ------------------------------------------------------------------------------

# Global values accessible to all charts
global:
  # Variant: onyx (default), onyx-foss (explicit FOSS intent), or custom (manual image config)
  # Note: onyx and onyx-foss use same onyxdotapp/* images; EE features require separate licensing
  variant: "onyx"
  # Registry prefix for air-gapped deployments (e.g., "my-registry.example.com/mirror")
  imageRegistry: ""
  # Pull secrets for private registries
  imagePullSecrets: []
  # Storage class for persistent volumes (empty = use cluster default)
  storageClass: ""

# ------------------------------------------------------------------------------
# CNPG PostgreSQL Configuration (Phase 3)
# ------------------------------------------------------------------------------
# CloudNative-PG cluster for HA PostgreSQL. Requires CNPG operator pre-installed.
# Set cnpg.enabled: false to use external PostgreSQL instead.

cnpg:
  # Enable CNPG-managed PostgreSQL (set false to use externalPostgresql)
  enabled: true

  # Cluster sizing
  instances: 3  # 1 primary + 2 replicas (minimum 2 for HA)

  # Storage configuration
  storage:
    size: 20Gi
    storageClass: ""  # Empty = use global.storageClass or cluster default

  # PostgreSQL resource limits
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  # PgBouncer connection pooler
  pooler:
    enabled: true
    instances: 2
    # Pool mode: transaction (recommended for web apps) or session
    poolMode: transaction
    parameters:
      default_pool_size: "25"
      max_client_conn: "1000"

  # Backup configuration (optional)
  backup:
    enabled: false
    # Cron schedule for scheduled backups
    schedule: "0 0 * * *"  # Daily at midnight UTC
    # Retention policy (e.g., "7d", "30d")
    retentionPolicy: "7d"
    # S3 configuration for backup storage (separate from Onyx object storage)
    s3:
      bucket: ""
      region: ""
      endpoint: ""
      # Use existingSecret for credentials (recommended)
      # Secret must contain AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
      existingSecret: ""

# ------------------------------------------------------------------------------
# External PostgreSQL Configuration
# ------------------------------------------------------------------------------
# Use when cnpg.enabled: false. Connect to existing PostgreSQL instance.

externalPostgresql:
  host: ""
  port: 5432
  database: "postgres"
  # Credentials - use existingSecret (recommended) or inline values
  existingSecret: ""  # Secret with 'username' and 'password' keys
  # Inline credentials (only if existingSecret is empty)
  username: ""
  password: ""

# ------------------------------------------------------------------------------
# Redis Configuration (Phase 4)
# ------------------------------------------------------------------------------
# Redis for Celery task queue. Three modes available:
#   1. Default: OT Container Kit Redis (standalone, via upstream subchart)
#   2. HA: Spotahome Redis Operator (requires operator pre-installed)
#   3. External: Connect to existing Redis (AWS ElastiCache, Azure Cache, etc.)
#
# Priority: externalRedis.host > redis.ha.enabled > redis.enabled (default)

redis:
  # Enable default OT Container Kit Redis (upstream subchart)
  # Set to false when using HA mode or external Redis
  enabled: true

  # HA mode using Spotahome Redis Operator (RedisFailover CRD)
  # Requires: Spotahome Redis Operator pre-installed in cluster
  # When enabled, redis.enabled should be set to false
  ha:
    enabled: false
    # Redis instances (followers)
    replicas: 3
    # Sentinel instances (for failover coordination)
    sentinels: 3
    # Resource limits for Redis pods
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    # Resource limits for Sentinel pods
    sentinelResources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
    # Storage configuration
    storage:
      # Persistence for Redis data
      enabled: true
      size: 2Gi
      storageClass: ""  # Empty = use global.storageClass or cluster default
    # Custom Redis configuration (optional)
    customConfig: {}

  # Database number for general Redis operations
  database: 0

# ------------------------------------------------------------------------------
# External Redis Configuration
# ------------------------------------------------------------------------------
# Use when both redis.enabled: false AND redis.ha.enabled: false.
# Connect to existing Redis instance (AWS ElastiCache, Azure Cache, etc.)

externalRedis:
  host: ""
  port: 6379
  # Credentials - use existingSecret (recommended) or inline password
  existingSecret: ""  # Secret with 'redis_password' key (matches OT Redis pattern)
  password: ""        # Only if existingSecret is empty
  # Database number
  database: 0
  # TLS configuration
  tls:
    enabled: false
    # Secret containing CA certificate (optional)
    secretName: ""

# ------------------------------------------------------------------------------
# Onyx Subchart Values (passthrough to upstream)
# ------------------------------------------------------------------------------
# All values under `onyx:` are passed directly to the upstream Onyx chart.
# Reference upstream values.yaml for full options:
# https://github.com/onyx-dot-app/onyx/blob/main/deployment/helm/charts/onyx/values.yaml

onyx:
  # Global settings (upstream)
  global:
    version: "latest"
    pullPolicy: "IfNotPresent"

  # ---------------------------------------------------------------------------
  # Components to DISABLE (replaced by our configuration in later phases)
  # ---------------------------------------------------------------------------

  # Phase 7: Replaced by Traefik ingress
  nginx:
    enabled: false

  # Phase 5: Replaced by external S3 (GarageFS/AWS S3/etc.)
  minio:
    enabled: false

  # ---------------------------------------------------------------------------
  # Components to RETAIN with defaults
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # Phase 3: Disable upstream CNPG operator reliance
  # ---------------------------------------------------------------------------
  # We use our own cnpg/cluster subchart (alias: postgresql-cluster) instead.
  # The upstream postgresql: alias controls the CNPG operator chart, which we
  # don't need since the operator is already installed cluster-wide.
  postgresql:
    enabled: false  # Disabled - using postgresql-cluster subchart instead

  # Vespa search engine - required for Onyx
  vespa:
    enabled: true

  # ---------------------------------------------------------------------------
  # Phase 4: Redis for Celery task queue
  # ---------------------------------------------------------------------------
  # This controls the upstream OT Container Kit Redis subchart.
  # The wrapper chart's redis.enabled controls whether this is active.
  # See redis: section (above onyx:) for wrapper-level Redis configuration.
  #
  # For HA Redis: Set redis.ha.enabled: true (above) and this will be disabled.
  # For external Redis: Set externalRedis.host (above) and this will be disabled.
  redis:
    enabled: true
    redisStandalone:
      # Service naming: {release}-master
      # This creates the service that REDIS_HOST points to
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
      redisSecret:
        secretName: onyx-redis
        secretKey: redis_password
    externalConfig:
      enabled: true
      data: |
        appendonly no
        save ""
        maxmemory 400mb
        maxmemory-policy allkeys-lru
        timeout 0
        tcp-keepalive 300
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi

  # OpenSearch - optional alternative to Vespa, disabled by default upstream
  opensearch:
    enabled: false

  # Code Interpreter - beta feature, disabled by default
  codeInterpreter:
    enabled: false

  # Slackbot - not needed by default
  slackbot:
    enabled: false

  # ---------------------------------------------------------------------------
  # Application Defaults
  # ---------------------------------------------------------------------------

  # Phase 6: Will be increased to 2 for HA
  api:
    replicaCount: 1

  # Phase 6: Will be increased to 2 for HA
  webserver:
    replicaCount: 1

  # ---------------------------------------------------------------------------
  # Ingress (managed by wrapper chart in Phase 7)
  # ---------------------------------------------------------------------------

  # We manage ingress via Traefik IngressRoute in the wrapper chart
  ingress:
    enabled: false

# ------------------------------------------------------------------------------
# CNPG Cluster Chart Values (alias: postgresql-cluster)
# ------------------------------------------------------------------------------
# Passthrough to cnpg/cluster subchart. Structure matches chart expectations.
# Only active when cnpg.enabled: true (via dependency condition).
#
# Key mappings from cnpg.* (our interface) to postgresql-cluster.* (chart interface):
#   cnpg.instances             -> postgresql-cluster.cluster.instances
#   cnpg.storage.size          -> postgresql-cluster.cluster.storage.size
#   cnpg.storage.storageClass  -> postgresql-cluster.cluster.storage.storageClass
#   cnpg.resources             -> postgresql-cluster.cluster.resources
#   cnpg.pooler.enabled        -> controls whether poolers[] is populated
#   cnpg.pooler.instances      -> postgresql-cluster.poolers[0].instances
#   cnpg.pooler.poolMode       -> postgresql-cluster.poolers[0].poolMode
#   cnpg.pooler.parameters     -> postgresql-cluster.poolers[0].parameters
#   cnpg.backup.enabled        -> postgresql-cluster.backups.enabled

postgresql-cluster:
  # Cluster type and mode
  type: postgresql
  mode: standalone

  # PostgreSQL version
  version:
    postgresql: "16"

  # Cluster configuration
  cluster:
    instances: 3  # Matches cnpg.instances default
    storage:
      size: 20Gi  # Matches cnpg.storage.size default
      storageClass: ""  # Matches cnpg.storage.storageClass default
    resources: {}  # Override via cnpg.resources or directly
    enableSuperuserAccess: true  # Required for Alembic migrations
    postgresql:
      parameters: {}
      pg_hba: []

  # PgBouncer poolers - created when cnpg.pooler.enabled: true
  # The cnpg/cluster chart creates Pooler CRs from this list
  poolers:
    - name: rw
      type: rw
      poolMode: transaction  # Matches cnpg.pooler.poolMode default
      instances: 2  # Matches cnpg.pooler.instances default
      parameters:
        default_pool_size: "25"  # Matches cnpg.pooler.parameters defaults
        max_client_conn: "1000"

  # Backups (disabled by default, configured via cnpg.backup.*)
  backups:
    enabled: false
