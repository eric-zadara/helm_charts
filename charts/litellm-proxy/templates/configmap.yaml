apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "litellm-proxy.fullname" . }}-config
  labels:
    {{- include "litellm-proxy.labels" . | nindent 4 }}
data:
  config.yaml: |
    model_list:
    {{- range .Values.litellm.modelList }}
      - model_name: {{ .modelName | quote }}
        litellm_params:
          model: {{ .litellmParams.model | quote }}
          api_base: {{ .litellmParams.apiBase | quote }}
          {{- with .litellmParams.apiKey }}
          api_key: {{ . | quote }}
          {{- end }}
          {{- with .litellmParams.rpm }}
          rpm: {{ . }}
          {{- end }}
          {{- with .litellmParams.tpm }}
          tpm: {{ . }}
          {{- end }}
          {{- with .litellmParams.extraParams }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
        {{- with .modelInfo }}
        model_info:
          {{- toYaml . | nindent 10 }}
        {{- end }}
    {{- end }}

    general_settings:
      master_key: os.environ/PROXY_MASTER_KEY
      database_url: os.environ/DATABASE_URL
      {{- with .Values.litellm.generalSettings }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

    litellm_settings:
      {{- with .Values.litellm.litellmSettings }}
      {{- /* Render all settings EXCEPT cache/cache_params which need special wiring */ -}}
      {{- $settings := deepCopy . }}
      {{- $_ := unset $settings "cache_params" }}
      {{- $_ := unset $settings "cache" }}
      {{- if $settings }}
      {{- toYaml $settings | nindent 6 }}
      {{- end }}
      {{- end }}
      {{- if .Values.cache.enabled }}
      cache: true
      cache_params:
        type: "redis"
        {{- $sentinelEnabled := include "litellm-proxy.cacheSentinelEnabled" . }}
        {{- if eq $sentinelEnabled "true" }}
        service_name: {{ .Values.cache.external.sentinel.serviceName | quote }}
        sentinel_nodes:
          - - {{ include "litellm-proxy.cacheHost" . | quote }}
            - {{ include "litellm-proxy.cachePort" . }}
        {{- else }}
        host: {{ include "litellm-proxy.cacheHost" . | quote }}
        port: {{ include "litellm-proxy.cachePort" . }}
        {{- end }}
        password: os.environ/REDIS_PASSWORD
        {{- with .Values.litellm.litellmSettings.cache_params }}
        {{- $params := deepCopy . }}
        {{- /* Remove keys already handled by infrastructure wiring */ -}}
        {{- $_ := unset $params "type" }}
        {{- $_ := unset $params "host" }}
        {{- $_ := unset $params "port" }}
        {{- $_ := unset $params "password" }}
        {{- $_ := unset $params "service_name" }}
        {{- $_ := unset $params "sentinel_nodes" }}
        {{- if $params }}
        {{- toYaml $params | nindent 8 }}
        {{- end }}
        {{- end }}
      {{- end }}

    router_settings:
    {{- if .Values.cache.enabled }}
      redis_host: {{ include "litellm-proxy.cacheHost" . | quote }}
      redis_port: {{ include "litellm-proxy.cachePort" . | quote }}
      redis_password: os.environ/REDIS_PASSWORD
    {{- end }}
    {{- with .Values.litellm.routerSettings }}
      {{- $settings := deepCopy . }}
      {{- $_ := unset $settings "redis_host" }}
      {{- $_ := unset $settings "redis_port" }}
      {{- $_ := unset $settings "redis_password" }}
      {{- if $settings }}
      {{- toYaml $settings | nindent 6 }}
      {{- end }}
    {{- end }}
