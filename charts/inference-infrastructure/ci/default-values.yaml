# CI test values for inference-infrastructure
# Tests full deployment with batteries-included CNPG and LiteLLM.
# Requires: CNPG operator (from inference-operators)

# Enable internal CNPG PostgreSQL cluster (batteries included)
postgresql:
  enabled: true
  cluster:
    instances: 1
    postgresql:
      # Disable synchronous replication for single-instance CI
      # Default values.yaml sets synchronous.number=1 for production (3 instances),
      # but with 1 instance there are no standbys to synchronously replicate to.
      # Setting to null overrides the deep-merged default and causes the CNPG
      # subchart template's {{- with .Values.cluster.postgresql.synchronous }}
      # block to be skipped entirely.
      synchronous: null
    initdb:
      database: "litellm"
      owner: "litellm"
    storage:
      size: "1Gi"

# Disable Valkey for simpler CI (litellm works without cache)
valkey:
  enabled: false

# Networking layer - minimal config (most requires Gateway API from envoy-gateway)
networking-layer:
  enabled: true
  # Disable envoy-gateway - requires Gateway API CRDs
  envoy-gateway:
    enabled: false
  # Disable kourier - requires Knative Serving CRDs
  kourier:
    enabled: false
  # Disable gateway - requires GatewayClass from Envoy Gateway
  gateway:
    name: ""
  # Disable TLS - requires cert-manager
  tls:
    enabled: false
  # Disable Knative ConfigMaps - requires Knative Serving namespace
  knative:
    enabled: false

# LiteLLM proxy - batteries included with internal CNPG
litellm-proxy:
  enabled: true
  replicaCount: 1

  # Use internal CNPG cluster from this chart's postgresql dependency
  database:
    internal:
      enabled: false  # We use the umbrella chart's postgresql, not litellm-proxy's
    external:
      # Points to the postgresql cluster created by this umbrella chart
      host: "inference-infrastructure-postgresql-rw"
      port: 5432
      name: "litellm"
      user: "litellm"
      secretName: "inference-infrastructure-postgresql-app"
      passwordSecretKey: "password"
    disableSchemaUpdate: "false"

  cache:
    enabled: false
    internal:
      enabled: false

  # Disable HTTPRoute (requires Gateway from envoy-gateway)
  httpRoute:
    enabled: false
  # Disable migration job - let litellm handle schema on startup
  migrationJob:
    enabled: false
  serviceMonitor:
    enabled: false

  # Wait for umbrella chart's database to be ready
  initContainers:
    waitForDatabase: true
    waitForCache: false

  # Use main port for health checks
  healthCheck:
    separateApp: false
    startup:
      initialDelaySeconds: 60
      failureThreshold: 60
