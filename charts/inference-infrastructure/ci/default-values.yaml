# CI test values for inference-infrastructure
# Minimal overlay on production defaults -- only override what differs for CI.
# Prerequisites: inference-operators (provides CNPG operator + all CRDs)
#
# Production defaults target release name "infra". CI installs as
# "inference-infrastructure", so litellm-proxy service names must be
# overridden to match the CI release name.

# PostgreSQL cluster - single instance and reduced resources for CI
postgresql:
  cluster:
    instances: 1
    storage:
      size: "1Gi"
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 500m
  # Reduce pooler to single instance for CI (production: 2)
  poolers:
    - name: rw
      type: rw
      instances: 1
      poolMode: transaction
      parameters:
        default_pool_size: "50"
        max_client_conn: "1000"

# Valkey cache - reduced resources for CI
valkey:
  master:
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 250m

# Networking layer overrides for CI
networking-layer:
  # Kourier - use production default (enabled), reduce replicas for CI
  kourier:
    controller:
      replicas: 1
    gateway:
      replicas: 1

  # Knative ConfigMaps - ENABLED (Knative Serving controller deployed by inference-operators)
  # Production defaults (knative.enabled: true) are used -- no override needed.

  # TLS - disabled (requires hostname)
  tls:
    enabled: false

# LiteLLM proxy - service name overrides for CI release name
# (production defaults assume release name "infra", CI uses "inference-infrastructure")
litellm-proxy:
  replicaCount: 1

  database:
    internal:
      enabled: false
    external:
      host: "inference-infrastructure-postgresql-rw"
      port: 5432
      name: "app"
      user: "app"
      secretName: "inference-infrastructure-postgresql-app"
      passwordSecretKey: "password"

  cache:
    internal:
      enabled: false
    external:
      host: "inference-infrastructure-valkey-primary"
      port: 6379
      secretName: "inference-infrastructure-valkey"
      passwordSecretKey: "valkey-password"

  # HTTPRoute - enabled (Gateway available from networking-layer)
  httpRoute:
    enabled: true
    gateway:
      name: "inference-infrastructure-networking-layer"
      namespace: "default"

  # Health checks - adjusted for startup time
  healthCheck:
    separateApp: false
    startup:
      initialDelaySeconds: 60
      failureThreshold: 60
