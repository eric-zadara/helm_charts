# Umbrella chart for LLM inference infrastructure
#
# This chart provides zero-config deployment of the complete inference stack:
# - PostgreSQL cluster (CNPG) for LiteLLM database
# - Valkey cache for LiteLLM caching
# - Networking layer (Envoy Gateway + Kourier)
# - LiteLLM API proxy (auto-wired to PostgreSQL/Valkey)
#
# RECOMMENDED DEPLOYMENT:
#   helm install infra ./charts/inference-infrastructure
#
# The "infra" release name produces these service names:
#   - PostgreSQL pooler: infra-postgresql-pooler-rw
#   - Valkey service: infra-valkey-master
#
# For external databases, disable the subcharts and override connection settings.

# Global values for cross-chart service discovery
global:
  namespace: ""

# =============================================================================
# DATABASE COMPONENTS
# =============================================================================

# PostgreSQL cluster (CNPG)
# Creates a highly-available PostgreSQL cluster with connection pooling
postgresql:
  # -- Enable PostgreSQL cluster deployment
  enabled: true

  mode: standalone
  type: postgresql

  cluster:
    # -- Number of PostgreSQL instances (1 for dev, 3+ for HA)
    # NOTE: If using synchronous replication, instances must be > synchronous.number
    instances: 3
    imageName: ghcr.io/cloudnative-pg/postgresql:17.4

    postgresql:
      # Synchronous replication - only enable for HA deployments (instances >= 2)
      # Uncomment for production HA:
      # synchronous:
      #   method: any
      #   number: 1
      parameters:
        max_connections: "200"
        shared_buffers: "256MB"

    storage:
      size: 50Gi

    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 1Gi
        cpu: 1000m

    affinity:
      podAntiAffinityType: preferred
      topologyKey: kubernetes.io/hostname

  # PgBouncer connection poolers
  poolers:
    - name: rw
      type: rw
      instances: 2
      poolMode: transaction
      parameters:
        default_pool_size: "50"
        max_client_conn: "1000"

# Valkey cache (Bitnami chart)
# Provides caching for LiteLLM responses
valkey:
  # -- Enable Valkey cache deployment
  enabled: true

  # Architecture: standalone or replication
  architecture: standalone

  # Authentication
  auth:
    enabled: true
    password: ""  # Auto-generated if empty

  # Master configuration
  master:
    persistence:
      enabled: false

    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 500m

# =============================================================================
# NETWORKING COMPONENTS
# =============================================================================

# Networking layer (Envoy Gateway + Kourier)
networking-layer:
  # -- Enable networking layer deployment
  enabled: true
  envoy-gateway:
    enabled: true
  kourier:
    enabled: true

# =============================================================================
# APPLICATION COMPONENTS
# =============================================================================

# LiteLLM API proxy
#
# SERVICE DISCOVERY:
# Default values expect release name "infra" which produces:
#   - PostgreSQL pooler: infra-postgresql-pooler-rw
#   - Valkey service: infra-valkey-master
#
# The litellm-proxy chart has its own internal database/cache,
# but in this umbrella chart we use the shared infrastructure.
litellm-proxy:
  # -- Enable LiteLLM proxy deployment
  enabled: true

  # Disable internal resources - use umbrella chart's shared infrastructure
  database:
    internal:
      enabled: false
    external:
      # Convention: CNPG pooler service is {release}-{alias}-pooler-{type}
      host: "infra-postgresql-pooler-rw"
      port: 5432
      name: "app"
      user: "app"
      # Convention: CNPG app secret is {release}-{alias}-app
      secretName: "infra-postgresql-app"
      passwordSecretKey: "password"

  cache:
    enabled: true
    internal:
      enabled: false
    external:
      # Convention: Bitnami Valkey service is {release}-valkey-master
      host: "infra-valkey-master"
      port: 6379
      # Convention: Bitnami Valkey secret is {release}-valkey
      secretName: "infra-valkey"
      passwordSecretKey: "valkey-password"
      sentinel:
        enabled: false

  # Disable HTTPRoute by default - networking-layer provides the gateway
  httpRoute:
    enabled: false

  # Migration job enabled - runs Prisma migration on install/upgrade
  migrationJob:
    enabled: true
