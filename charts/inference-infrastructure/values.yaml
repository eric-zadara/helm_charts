# Umbrella chart for LLM inference infrastructure
#
# This chart provides zero-config deployment of the complete inference stack:
# - PostgreSQL cluster (CNPG) for LiteLLM database
# - Valkey cache for LiteLLM caching
# - Networking layer (Envoy Gateway + Kourier)
# - LiteLLM API proxy (auto-wired to PostgreSQL/Valkey)
#
# RECOMMENDED DEPLOYMENT:
#   helm install infra ./charts/inference-infrastructure
#
# The "infra" release name produces these service names:
#   - PostgreSQL pooler: infra-postgresql-pooler-rw
#   - Valkey service: infra-valkey
#
# For external databases, disable the subcharts and override connection settings.

# Global values for cross-chart service discovery
global:
  namespace: ""

# =============================================================================
# DATABASE COMPONENTS
# =============================================================================

# PostgreSQL cluster (CNPG)
# Creates a highly-available PostgreSQL cluster with connection pooling
postgresql:
  # -- Enable PostgreSQL cluster deployment
  enabled: true

  mode: standalone
  type: postgresql

  cluster:
    instances: 3
    imageName: ghcr.io/cloudnative-pg/postgresql:17.4

    postgresql:
      synchronous:
        method: any
        number: 1
      parameters:
        max_connections: "200"
        shared_buffers: "256MB"

    storage:
      size: 50Gi

    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 1Gi
        cpu: 1000m

    affinity:
      podAntiAffinityType: preferred
      topologyKey: kubernetes.io/hostname

  # PgBouncer connection poolers
  poolers:
    - name: rw
      type: rw
      instances: 2
      poolMode: transaction
      parameters:
        default_pool_size: "50"
        max_client_conn: "1000"

# Valkey cache (official valkey-io/valkey-helm chart)
# Provides caching for LiteLLM responses
valkey:
  # -- Enable Valkey cache deployment
  enabled: true

  # Replica configuration
  replica:
    replicaCount: 2

  # No persistence - ephemeral cache
  persistence:
    enabled: false

  # Authentication - default user with password
  auth:
    enabled: true
    aclUsers:
      default:
        permissions: "~* &* +@all"
        password: "changeme"  # Override in production!

  # Service configuration
  service:
    type: ClusterIP
    port: 6379

  # Resources
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

# =============================================================================
# NETWORKING COMPONENTS
# =============================================================================

# Networking layer (Envoy Gateway + Kourier)
networking-layer:
  # -- Enable networking layer deployment
  enabled: true
  envoyGateway:
    enabled: true
  kourier:
    enabled: true

# =============================================================================
# APPLICATION COMPONENTS
# =============================================================================

# LiteLLM API proxy
#
# SERVICE DISCOVERY:
# Default values expect release name "infra" which produces:
#   - PostgreSQL pooler: infra-postgresql-pooler-rw
#   - Valkey service: infra-valkey
#
# For different release names or external databases, override these values.
litellm-proxy:
  # -- Enable LiteLLM proxy deployment
  enabled: true

  # Database connection
  # Convention: CNPG pooler service is {release}-{alias}-pooler-{type}
  database:
    host: "infra-postgresql-pooler-rw"
    port: 5432
    name: "app"
    user: "app"
    # Convention: CNPG app secret is {release}-{alias}-app
    passwordSecretName: "infra-postgresql-app"
    passwordSecretKey: "password"

  # Cache connection
  # Convention: Valkey service is {release}-valkey
  cache:
    enabled: true
    sentinel:
      enabled: false  # Official valkey chart doesn't support Sentinel
    host: "infra-valkey"
    port: 6379
    # Convention: Valkey auth secret is {release}-valkey-auth with key {username}-password
    passwordSecretName: "infra-valkey-auth"
    passwordSecretKey: "default-password"

  # Disable HTTPRoute by default - networking-layer provides the gateway
  httpRoute:
    enabled: false

  # Migration job enabled - runs Prisma migration on install/upgrade
  migrationJob:
    enabled: true
