{{/*
EPP configuration file.
Only created when epp.poolName is set.
EPP v1.3.0 crashes with nil pointer when no config file is provided.
When schedulingConfig is disabled, a minimal valid config is used
(EPP applies its built-in defaults).
*/}}
{{- if .Values.epp.poolName }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "inference-gateway.eppName" . }}-config
  labels:
    {{- include "inference-gateway.labels" . | nindent 4 }}
    app.kubernetes.io/component: epp
data:
  epp-config.yaml: |
    apiVersion: inference.networking.x-k8s.io/v1alpha1
    kind: EndpointPickerConfig
    {{- if .Values.epp.schedulingConfig.enabled }}
    schedulingProfiles:
      - name: default
        plugins:
          - pluginRef: prefix-cache-scorer
            weight: {{ .Values.epp.schedulingConfig.scorers.prefixCacheScorer }}
          - pluginRef: kv-cache-utilization-scorer
            weight: {{ .Values.epp.schedulingConfig.scorers.kvCacheUtilizationScorer }}
          - pluginRef: queue-scorer
            weight: {{ .Values.epp.schedulingConfig.scorers.queueScorer }}
          - pluginRef: {{ .Values.epp.schedulingConfig.picker }}
    saturationDetector:
      queueDepthThreshold: {{ .Values.epp.schedulingConfig.saturationDetector.queueDepthThreshold }}
      kvCacheUtilThreshold: {{ .Values.epp.schedulingConfig.saturationDetector.kvCacheUtilThreshold }}
      metricsStalenessThreshold: {{ .Values.epp.schedulingConfig.saturationDetector.metricsStalenessThreshold | quote }}
    {{- end }}
{{- end }}
