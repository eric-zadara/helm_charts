name: Test Charts

on:
  pull_request:
    branches:
      - master
    paths:
      - 'charts/**'
      - 'ct.yaml'
      - '.github/workflows/test.yml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      tier1_charts: ${{ steps.categorize.outputs.tier1 }}
      tier2_charts: ${{ steps.categorize.outputs.tier2 }}
      tier3_charts: ${{ steps.categorize.outputs.tier3 }}
      has_changes: ${{ steps.categorize.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: Categorize changed charts into tiers
        id: categorize
        run: |
          # Get list of changed charts using ct
          changed=$(ct list-changed --config ct.yaml 2>/dev/null || echo "")

          if [[ -z "$changed" ]]; then
            echo "No chart changes detected"
            echo "tier1=[]" >> "$GITHUB_OUTPUT"
            echo "tier2=[]" >> "$GITHUB_OUTPUT"
            echo "tier3=[]" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed charts detected:"
          echo "$changed"

          # Initialize tier arrays
          tier1=()
          tier2=()
          tier3=()

          # Categorize each changed chart
          while IFS= read -r chart_path; do
            # Extract chart name from path (charts/name -> name)
            chart=$(basename "$chart_path")

            case "$chart" in
              gateway-api|knative-serving-crds|kserve-crds|inference-extension-crds)
                tier1+=("$chart")
                ;;
              networking-layer|litellm-proxy|model-serving|inference-gateway)
                tier2+=("$chart")
                ;;
              inference-operators|inference-infrastructure|inference-stack)
                tier3+=("$chart")
                ;;
              *)
                echo "Chart '$chart' not in inference tier categories, skipping"
                ;;
            esac
          done <<< "$changed"

          # Convert arrays to JSON format for matrix
          tier1_json=$(printf '%s\n' "${tier1[@]}" | jq -R . | jq -s -c .)
          tier2_json=$(printf '%s\n' "${tier2[@]}" | jq -R . | jq -s -c .)
          tier3_json=$(printf '%s\n' "${tier3[@]}" | jq -R . | jq -s -c .)

          # Handle empty arrays
          [[ -z "$tier1_json" || "$tier1_json" == '[""]' ]] && tier1_json="[]"
          [[ -z "$tier2_json" || "$tier2_json" == '[""]' ]] && tier2_json="[]"
          [[ -z "$tier3_json" || "$tier3_json" == '[""]' ]] && tier3_json="[]"

          echo "Tier 1 (CRDs): $tier1_json"
          echo "Tier 2 (Components): $tier2_json"
          echo "Tier 3 (Umbrellas): $tier3_json"

          echo "tier1=$tier1_json" >> "$GITHUB_OUTPUT"
          echo "tier2=$tier2_json" >> "$GITHUB_OUTPUT"
          echo "tier3=$tier3_json" >> "$GITHUB_OUTPUT"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

  test-tier1:
    name: Test Tier 1 (CRDs) - ${{ matrix.chart }} on K8s ${{ matrix.k8s-version }}
    needs: detect-changes
    if: needs.detect-changes.outputs.tier1_charts != '[]' && needs.detect-changes.outputs.tier1_charts != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - "1.35.0"
          - "1.34.3"
          - "1.33.7"
        chart: ${{ fromJSON(needs.detect-changes.outputs.tier1_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ matrix.k8s-version == '1.35.0' && 'kindest/node:v1.35.0@sha256:452d707d4862f52530247495d180205e029056831160e22870e37e3f6c1ac31f' || matrix.k8s-version == '1.34.3' && 'kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48' || 'kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040' }}
          cluster_name: tier1-${{ matrix.chart }}-${{ matrix.k8s-version }}
          wait: 300s

      - name: Install chart
        run: |
          helm dependency build charts/${{ matrix.chart }} 2>/dev/null || true
          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            --namespace default \
            --wait \
            --timeout 600s

      - name: Verify CRDs installed
        run: |
          echo "Verifying CRDs for ${{ matrix.chart }}..."

          case "${{ matrix.chart }}" in
            gateway-api)
              expected_count=6
              expected_crds="gatewayclasses.gateway.networking.k8s.io gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io grpcroutes.gateway.networking.k8s.io referencegrants.gateway.networking.k8s.io backendtlspolicies.gateway.networking.k8s.io"
              ;;
            knative-serving-crds)
              expected_count=12
              expected_crds=""
              ;;
            kserve-crds)
              expected_count=11
              expected_crds=""
              ;;
            inference-extension-crds)
              expected_count=5
              expected_crds=""
              ;;
            *)
              echo "Unknown CRD chart: ${{ matrix.chart }}"
              exit 1
              ;;
          esac

          # Verify specific CRDs if defined
          if [[ -n "$expected_crds" ]]; then
            for crd in $expected_crds; do
              echo "Checking CRD: $crd"
              if ! kubectl get crd "$crd" > /dev/null 2>&1; then
                echo "FAIL: CRD $crd not found"
                kubectl get crd
                exit 1
              fi
              echo "OK: $crd exists"
            done
          fi

          # Verify minimum CRD count
          actual_count=$(kubectl get crd --no-headers 2>/dev/null | wc -l)
          echo "Found $actual_count CRDs in cluster"

          if [[ "$actual_count" -lt "$expected_count" ]]; then
            echo "FAIL: Expected at least $expected_count CRDs, found $actual_count"
            kubectl get crd
            exit 1
          fi

          echo "PASS: CRD verification complete ($actual_count CRDs found, expected >= $expected_count)"

      - name: Run helm test
        run: |
          helm test ${{ matrix.chart }} --namespace default --timeout 300s || true
          echo "Helm test completed (tests may not be defined for this chart)"

  test-tier2:
    name: Test Tier 2 (Components) - ${{ matrix.chart }} on K8s ${{ matrix.k8s-version }}
    needs: [detect-changes, test-tier1]
    if: always() && needs.detect-changes.outputs.tier2_charts != '[]' && needs.detect-changes.outputs.tier2_charts != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - "1.35.0"
          - "1.34.3"
          - "1.33.7"
        chart: ${{ fromJSON(needs.detect-changes.outputs.tier2_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ matrix.k8s-version == '1.35.0' && 'kindest/node:v1.35.0@sha256:452d707d4862f52530247495d180205e029056831160e22870e37e3f6c1ac31f' || matrix.k8s-version == '1.34.3' && 'kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48' || 'kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040' }}
          cluster_name: tier2-${{ matrix.chart }}-${{ matrix.k8s-version }}
          wait: 300s

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo update

      - name: Install Tier 1 CRD prerequisites
        run: |
          echo "Installing CRD prerequisites for tier 2 charts..."

          # Install gateway-api CRDs (required by networking-layer, inference-gateway)
          helm dependency build charts/gateway-api 2>/dev/null || true
          helm install gateway-api charts/gateway-api --namespace default --wait --timeout 300s

          # Install knative-serving-crds (required by model-serving)
          helm dependency build charts/knative-serving-crds 2>/dev/null || true
          helm install knative-serving-crds charts/knative-serving-crds --namespace default --wait --timeout 300s

          # Install kserve-crds (required by model-serving)
          helm dependency build charts/kserve-crds 2>/dev/null || true
          helm install kserve-crds charts/kserve-crds --namespace default --wait --timeout 300s

          # Install inference-extension-crds (required by inference-gateway)
          helm dependency build charts/inference-extension-crds 2>/dev/null || true
          helm install inference-extension-crds charts/inference-extension-crds --namespace default --wait --timeout 300s

          echo "CRD prerequisites installed"

      - name: Install chart
        run: |
          helm dependency build charts/${{ matrix.chart }} 2>/dev/null || true
          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            --namespace default \
            --wait \
            --timeout 600s

      - name: Verify installation
        run: |
          echo "Verifying ${{ matrix.chart }} installation..."
          kubectl get all -n default
          echo "Installation verification complete"

      - name: Run helm test
        run: |
          helm test ${{ matrix.chart }} --namespace default --timeout 300s || true
          echo "Helm test completed (tests may not be defined for this chart)"

  test-tier3:
    name: Test Tier 3 (Umbrellas) - ${{ matrix.chart }} on K8s ${{ matrix.k8s-version }}
    needs: [detect-changes, test-tier2]
    if: always() && needs.detect-changes.outputs.tier3_charts != '[]' && needs.detect-changes.outputs.tier3_charts != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - "1.35.0"
          - "1.34.3"
          - "1.33.7"
        chart: ${{ fromJSON(needs.detect-changes.outputs.tier3_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ matrix.k8s-version == '1.35.0' && 'kindest/node:v1.35.0@sha256:452d707d4862f52530247495d180205e029056831160e22870e37e3f6c1ac31f' || matrix.k8s-version == '1.34.3' && 'kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48' || 'kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040' }}
          cluster_name: tier3-${{ matrix.chart }}-${{ matrix.k8s-version }}
          wait: 300s

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo update

      - name: Install Tier 1 CRD prerequisites
        run: |
          echo "Installing CRD prerequisites for tier 3 charts..."

          # Install all CRD charts as prerequisites
          for crd_chart in gateway-api knative-serving-crds kserve-crds inference-extension-crds; do
            helm dependency build "charts/$crd_chart" 2>/dev/null || true
            helm install "$crd_chart" "charts/$crd_chart" --namespace default --wait --timeout 300s
          done

          echo "CRD prerequisites installed"

      - name: Install Tier 2 component prerequisites
        run: |
          echo "Installing component prerequisites for tier 3 charts..."

          # Install component charts that umbrella charts may depend on
          for component_chart in networking-layer litellm-proxy model-serving inference-gateway; do
            helm dependency build "charts/$component_chart" 2>/dev/null || true
            helm install "$component_chart" "charts/$component_chart" --namespace default --wait --timeout 600s || true
          done

          echo "Component prerequisites installed"

      - name: Install chart
        run: |
          helm dependency build charts/${{ matrix.chart }} 2>/dev/null || true
          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            --namespace default \
            --wait \
            --timeout 600s

      - name: Verify installation
        run: |
          echo "Verifying ${{ matrix.chart }} installation..."
          kubectl get all -n default
          echo "Installation verification complete"

      - name: Run helm test
        run: |
          helm test ${{ matrix.chart }} --namespace default --timeout 300s || true
          echo "Helm test completed (tests may not be defined for this chart)"
