name: Full Chart Test

on:
  schedule:
    # Every Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      chart:
        description: 'Chart to test (leave empty for all charts)'
        required: false
        type: string
        default: ''
      k8s_version:
        description: 'Kubernetes version to test'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - '1.35.0'
          - '1.34.3'
          - '1.33.7'

env:
  # SHA256-pinned kind node images for reproducibility
  NODE_IMAGE_1_35_0: 'kindest/node:v1.35.0@sha256:452d707d4862f52530247495d180205e029056831160e22870e37e3f6c1ac31f'
  NODE_IMAGE_1_34_3: 'kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48'
  NODE_IMAGE_1_33_7: 'kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040'

jobs:
  # Discover charts and categorize by tier from Chart.yaml annotations
  discover:
    runs-on: ubuntu-latest
    outputs:
      tier0_charts: ${{ steps.categorize.outputs.tier0 }}
      tier1_charts: ${{ steps.categorize.outputs.tier1 }}
      tier2_charts: ${{ steps.categorize.outputs.tier2 }}
      tier3_charts: ${{ steps.categorize.outputs.tier3 }}
      k8s_versions: ${{ steps.versions.outputs.versions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up yq
        uses: mikefarah/yq@v4.45.4

      - name: Discover and categorize charts
        id: categorize
        run: |
          # Initialize tier arrays
          tier0=()
          tier1=()
          tier2=()
          tier3=()

          # Get chart filter (empty means all)
          chart_filter="${{ github.event.inputs.chart }}"

          # Discover all charts
          for chart_yaml in charts/*/Chart.yaml; do
            chart_name=$(dirname "$chart_yaml" | xargs basename)

            # Skip if chart filter is set and doesn't match
            if [[ -n "$chart_filter" && "$chart_name" != "$chart_filter" ]]; then
              continue
            fi

            # Read tier from annotations (default: 0)
            tier=$(yq -r '.annotations["testing/tier"] // "0"' "$chart_yaml")

            # Categorize by tier
            case "$tier" in
              0) tier0+=("$chart_name") ;;
              1) tier1+=("$chart_name") ;;
              2) tier2+=("$chart_name") ;;
              3) tier3+=("$chart_name") ;;
              *) tier0+=("$chart_name") ;;  # Unknown tier defaults to 0
            esac

            echo "Chart: $chart_name -> tier $tier"
          done

          # Convert arrays to JSON
          tier0_json=$(printf '%s\n' "${tier0[@]}" | jq -R . | jq -s -c .)
          tier1_json=$(printf '%s\n' "${tier1[@]}" | jq -R . | jq -s -c .)
          tier2_json=$(printf '%s\n' "${tier2[@]}" | jq -R . | jq -s -c .)
          tier3_json=$(printf '%s\n' "${tier3[@]}" | jq -R . | jq -s -c .)

          # Handle empty arrays
          [[ "$tier0_json" == '[""]' ]] && tier0_json='[]'
          [[ "$tier1_json" == '[""]' ]] && tier1_json='[]'
          [[ "$tier2_json" == '[""]' ]] && tier2_json='[]'
          [[ "$tier3_json" == '[""]' ]] && tier3_json='[]'

          echo "tier0=$tier0_json" >> "$GITHUB_OUTPUT"
          echo "tier1=$tier1_json" >> "$GITHUB_OUTPUT"
          echo "tier2=$tier2_json" >> "$GITHUB_OUTPUT"
          echo "tier3=$tier3_json" >> "$GITHUB_OUTPUT"

          echo ""
          echo "Summary:"
          echo "  Tier 0 (independent): $tier0_json"
          echo "  Tier 1 (CRDs): $tier1_json"
          echo "  Tier 2 (components): $tier2_json"
          echo "  Tier 3 (umbrellas): $tier3_json"

      - name: Determine K8s versions
        id: versions
        run: |
          version_input="${{ github.event.inputs.k8s_version || 'all' }}"

          if [[ "$version_input" == "all" ]]; then
            echo 'versions=["1.35.0","1.34.3","1.33.7"]' >> "$GITHUB_OUTPUT"
          else
            echo "versions=[\"$version_input\"]" >> "$GITHUB_OUTPUT"
          fi

  # Tier 0: Independent charts (no prerequisites, no annotations)
  test-tier0:
    needs: discover
    if: needs.discover.outputs.tier0_charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version: ${{ fromJSON(needs.discover.outputs.k8s_versions) }}
        chart: ${{ fromJSON(needs.discover.outputs.tier0_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Set up yq
        uses: mikefarah/yq@v4.45.4

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add eric-zadara https://eric-zadara.github.io/helm_charts/
          helm repo update

      - name: Get node image
        id: node-image
        run: |
          case "${{ matrix.k8s-version }}" in
            1.35.0) echo "image=$NODE_IMAGE_1_35_0" >> "$GITHUB_OUTPUT" ;;
            1.34.3) echo "image=$NODE_IMAGE_1_34_3" >> "$GITHUB_OUTPUT" ;;
            1.33.7) echo "image=$NODE_IMAGE_1_33_7" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ steps.node-image.outputs.image }}
          cluster_name: chart-testing-${{ matrix.k8s-version }}
          wait: 300s

      - name: Install prerequisites
        run: |
          prereqs=$(yq -r '.annotations["testing/prerequisites"] // ""' "charts/${{ matrix.chart }}/Chart.yaml")

          if [[ -z "$prereqs" ]]; then
            echo "No prerequisites for ${{ matrix.chart }}"
            exit 0
          fi

          echo "Installing prerequisites: $prereqs"
          IFS=',' read -ra prereq_list <<< "$prereqs"

          # Helper: idempotent install of a local chart prerequisite
          install_prereq() {
            local chart=$1 timeout=$2
            if helm status "$chart" -n default &>/dev/null; then
              echo "$chart already installed, skipping"
              return 0
            fi
            echo "Installing $chart..."
            helm dependency build "charts/$chart"
            local values_args=""
            if [[ -f "charts/$chart/ci/default-values.yaml" ]]; then
              values_args="-f charts/$chart/ci/default-values.yaml"
            fi
            helm install "$chart" "charts/$chart" \
              $values_args \
              --namespace default \
              --wait --timeout "$timeout"
          }

          for prereq in "${prereq_list[@]}"; do
            case "$prereq" in
              tier1-crds)
                echo "Installing tier1 CRD charts..."
                for crd_chart in charts/*/Chart.yaml; do
                  tier=$(yq -r '.annotations["testing/tier"] // "0"' "$crd_chart")
                  if [[ "$tier" == "1" ]]; then
                    chart_name=$(dirname "$crd_chart" | xargs basename)
                    echo "  Installing $chart_name..."
                    helm dependency build "charts/$chart_name" 2>/dev/null || true
                    helm install "$chart_name" "charts/$chart_name" --namespace default --wait --timeout 5m
                  fi
                done
                ;;
              cert-manager)
                echo "Installing cert-manager..."
                helm repo add jetstack https://charts.jetstack.io
                helm repo update
                helm install cert-manager jetstack/cert-manager \
                  --namespace cert-manager --create-namespace \
                  --set crds.enabled=true \
                  --wait --timeout 5m
                ;;
              cnpg-operator)
                echo "Installing CNPG operator..."
                helm install cnpg cnpg/cloudnative-pg \
                  --namespace cnpg-system --create-namespace \
                  --wait --timeout 5m
                ;;
              inference-crds)
                install_prereq inference-crds 5m
                ;;
              inference-operators)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                ;;
              inference-infrastructure)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                install_prereq inference-infrastructure 15m
                ;;
              *)
                echo "Unknown prerequisite: $prereq"
                ;;
            esac
          done

      - name: Build chart dependencies
        run: helm dependency build charts/${{ matrix.chart }}

      - name: Install chart
        run: |
          # Use CI values file if it exists
          VALUES_ARGS=""
          if [[ -f "charts/${{ matrix.chart }}/ci/default-values.yaml" ]]; then
            VALUES_ARGS="-f charts/${{ matrix.chart }}/ci/default-values.yaml"
            echo "Using CI values file: charts/${{ matrix.chart }}/ci/default-values.yaml"
          fi

          # Per-chart timeout from annotation, default 10m
          TIMEOUT=$(yq -r '.annotations["testing/timeout"] // "10m"' "charts/${{ matrix.chart }}/Chart.yaml")
          echo "Install timeout: $TIMEOUT"

          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            $VALUES_ARGS \
            --namespace default \
            --wait \
            --timeout "$TIMEOUT"

      - name: Run helm test
        run: helm test ${{ matrix.chart }} --namespace default

  # Tier 1: CRD charts (foundation layer)
  test-tier1:
    needs: discover
    if: needs.discover.outputs.tier1_charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version: ${{ fromJSON(needs.discover.outputs.k8s_versions) }}
        chart: ${{ fromJSON(needs.discover.outputs.tier1_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Set up yq
        uses: mikefarah/yq@v4.45.4

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add eric-zadara https://eric-zadara.github.io/helm_charts/
          helm repo update

      - name: Get node image
        id: node-image
        run: |
          case "${{ matrix.k8s-version }}" in
            1.35.0) echo "image=$NODE_IMAGE_1_35_0" >> "$GITHUB_OUTPUT" ;;
            1.34.3) echo "image=$NODE_IMAGE_1_34_3" >> "$GITHUB_OUTPUT" ;;
            1.33.7) echo "image=$NODE_IMAGE_1_33_7" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ steps.node-image.outputs.image }}
          cluster_name: chart-testing-${{ matrix.k8s-version }}
          wait: 300s

      - name: Build chart dependencies
        run: helm dependency build charts/${{ matrix.chart }}

      - name: Install chart
        run: |
          # Use CI values file if it exists
          VALUES_ARGS=""
          if [[ -f "charts/${{ matrix.chart }}/ci/default-values.yaml" ]]; then
            VALUES_ARGS="-f charts/${{ matrix.chart }}/ci/default-values.yaml"
            echo "Using CI values file: charts/${{ matrix.chart }}/ci/default-values.yaml"
          fi

          # Per-chart timeout from annotation, default 5m
          TIMEOUT=$(yq -r '.annotations["testing/timeout"] // "5m"' "charts/${{ matrix.chart }}/Chart.yaml")
          echo "Install timeout: $TIMEOUT"

          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            $VALUES_ARGS \
            --namespace default \
            --wait \
            --timeout "$TIMEOUT"

      - name: Verify CRDs installed
        run: |
          echo "Verifying CRDs for ${{ matrix.chart }}..."
          crd_count=$(kubectl get crd --no-headers 2>/dev/null | wc -l)
          echo "Found $crd_count CRDs"

          if [[ "$crd_count" -eq 0 ]]; then
            echo "WARNING: No CRDs found for CRD chart ${{ matrix.chart }}"
          fi

          kubectl get crd

      - name: Run helm test
        run: helm test ${{ matrix.chart }} --namespace default

  # Tier 2: Component charts (require CRDs and/or operators)
  test-tier2:
    needs: [discover, test-tier1]
    if: always() && needs.discover.outputs.tier2_charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version: ${{ fromJSON(needs.discover.outputs.k8s_versions) }}
        chart: ${{ fromJSON(needs.discover.outputs.tier2_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Set up yq
        uses: mikefarah/yq@v4.45.4

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add eric-zadara https://eric-zadara.github.io/helm_charts/
          helm repo update

      - name: Get node image
        id: node-image
        run: |
          case "${{ matrix.k8s-version }}" in
            1.35.0) echo "image=$NODE_IMAGE_1_35_0" >> "$GITHUB_OUTPUT" ;;
            1.34.3) echo "image=$NODE_IMAGE_1_34_3" >> "$GITHUB_OUTPUT" ;;
            1.33.7) echo "image=$NODE_IMAGE_1_33_7" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ steps.node-image.outputs.image }}
          cluster_name: chart-testing-${{ matrix.k8s-version }}
          wait: 300s

      - name: Install prerequisites
        run: |
          prereqs=$(yq -r '.annotations["testing/prerequisites"] // ""' "charts/${{ matrix.chart }}/Chart.yaml")

          if [[ -z "$prereqs" ]]; then
            echo "No prerequisites for ${{ matrix.chart }}"
            exit 0
          fi

          echo "Installing prerequisites: $prereqs"
          IFS=',' read -ra prereq_list <<< "$prereqs"

          # Helper: idempotent install of a local chart prerequisite
          install_prereq() {
            local chart=$1 timeout=$2
            if helm status "$chart" -n default &>/dev/null; then
              echo "$chart already installed, skipping"
              return 0
            fi
            echo "Installing $chart..."
            helm dependency build "charts/$chart"
            local values_args=""
            if [[ -f "charts/$chart/ci/default-values.yaml" ]]; then
              values_args="-f charts/$chart/ci/default-values.yaml"
            fi
            helm install "$chart" "charts/$chart" \
              $values_args \
              --namespace default \
              --wait --timeout "$timeout"
          }

          for prereq in "${prereq_list[@]}"; do
            case "$prereq" in
              tier1-crds)
                echo "Installing tier1 CRD charts..."
                for crd_chart in charts/*/Chart.yaml; do
                  tier=$(yq -r '.annotations["testing/tier"] // "0"' "$crd_chart")
                  if [[ "$tier" == "1" ]]; then
                    chart_name=$(dirname "$crd_chart" | xargs basename)
                    echo "  Installing $chart_name..."
                    helm dependency build "charts/$chart_name" 2>/dev/null || true
                    helm install "$chart_name" "charts/$chart_name" --namespace default --wait --timeout 5m
                  fi
                done
                ;;
              cert-manager)
                echo "Installing cert-manager..."
                helm repo add jetstack https://charts.jetstack.io
                helm repo update
                helm install cert-manager jetstack/cert-manager \
                  --namespace cert-manager --create-namespace \
                  --set crds.enabled=true \
                  --wait --timeout 5m
                ;;
              cnpg-operator)
                echo "Installing CNPG operator..."
                helm install cnpg cnpg/cloudnative-pg \
                  --namespace cnpg-system --create-namespace \
                  --wait --timeout 5m
                ;;
              inference-crds)
                install_prereq inference-crds 5m
                ;;
              inference-operators)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                ;;
              inference-infrastructure)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                install_prereq inference-infrastructure 15m
                ;;
              *)
                echo "Unknown prerequisite: $prereq"
                ;;
            esac
          done

      - name: Build chart dependencies
        run: helm dependency build charts/${{ matrix.chart }}

      - name: Install chart
        run: |
          # Use CI values file if it exists
          VALUES_ARGS=""
          if [[ -f "charts/${{ matrix.chart }}/ci/default-values.yaml" ]]; then
            VALUES_ARGS="-f charts/${{ matrix.chart }}/ci/default-values.yaml"
            echo "Using CI values file: charts/${{ matrix.chart }}/ci/default-values.yaml"
          fi

          # Per-chart timeout from annotation, default 10m
          TIMEOUT=$(yq -r '.annotations["testing/timeout"] // "10m"' "charts/${{ matrix.chart }}/Chart.yaml")
          echo "Install timeout: $TIMEOUT"

          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            $VALUES_ARGS \
            --namespace default \
            --wait \
            --timeout "$TIMEOUT"

      - name: Verify resources
        run: |
          echo "Verifying resources for ${{ matrix.chart }}..."
          kubectl get all -n default -l app.kubernetes.io/instance=${{ matrix.chart }} || true

      - name: Run helm test
        run: helm test ${{ matrix.chart }} --namespace default

  # Tier 3: Umbrella charts (aggregate multiple components)
  test-tier3:
    needs: [discover, test-tier2]
    if: always() && needs.discover.outputs.tier3_charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version: ${{ fromJSON(needs.discover.outputs.k8s_versions) }}
        chart: ${{ fromJSON(needs.discover.outputs.tier3_charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Set up yq
        uses: mikefarah/yq@v4.45.4

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add eric-zadara https://eric-zadara.github.io/helm_charts/
          helm repo update

      - name: Get node image
        id: node-image
        run: |
          case "${{ matrix.k8s-version }}" in
            1.35.0) echo "image=$NODE_IMAGE_1_35_0" >> "$GITHUB_OUTPUT" ;;
            1.34.3) echo "image=$NODE_IMAGE_1_34_3" >> "$GITHUB_OUTPUT" ;;
            1.33.7) echo "image=$NODE_IMAGE_1_33_7" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ steps.node-image.outputs.image }}
          cluster_name: chart-testing-${{ matrix.k8s-version }}
          wait: 300s

      - name: Install prerequisites
        run: |
          prereqs=$(yq -r '.annotations["testing/prerequisites"] // ""' "charts/${{ matrix.chart }}/Chart.yaml")

          if [[ -z "$prereqs" ]]; then
            echo "No prerequisites for ${{ matrix.chart }}"
            exit 0
          fi

          echo "Installing prerequisites: $prereqs"
          IFS=',' read -ra prereq_list <<< "$prereqs"

          # Helper: idempotent install of a local chart prerequisite
          install_prereq() {
            local chart=$1 timeout=$2
            if helm status "$chart" -n default &>/dev/null; then
              echo "$chart already installed, skipping"
              return 0
            fi
            echo "Installing $chart..."
            helm dependency build "charts/$chart"
            local values_args=""
            if [[ -f "charts/$chart/ci/default-values.yaml" ]]; then
              values_args="-f charts/$chart/ci/default-values.yaml"
            fi
            helm install "$chart" "charts/$chart" \
              $values_args \
              --namespace default \
              --wait --timeout "$timeout"
          }

          for prereq in "${prereq_list[@]}"; do
            case "$prereq" in
              tier1-crds)
                echo "Installing tier1 CRD charts..."
                for crd_chart in charts/*/Chart.yaml; do
                  tier=$(yq -r '.annotations["testing/tier"] // "0"' "$crd_chart")
                  if [[ "$tier" == "1" ]]; then
                    chart_name=$(dirname "$crd_chart" | xargs basename)
                    echo "  Installing $chart_name..."
                    helm dependency build "charts/$chart_name" 2>/dev/null || true
                    helm install "$chart_name" "charts/$chart_name" --namespace default --wait --timeout 5m
                  fi
                done
                ;;
              cert-manager)
                echo "Installing cert-manager..."
                helm repo add jetstack https://charts.jetstack.io
                helm repo update
                helm install cert-manager jetstack/cert-manager \
                  --namespace cert-manager --create-namespace \
                  --set crds.enabled=true \
                  --wait --timeout 5m
                ;;
              cnpg-operator)
                echo "Installing CNPG operator..."
                helm install cnpg cnpg/cloudnative-pg \
                  --namespace cnpg-system --create-namespace \
                  --wait --timeout 5m
                ;;
              inference-crds)
                install_prereq inference-crds 5m
                ;;
              inference-operators)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                ;;
              inference-infrastructure)
                install_prereq inference-crds 5m
                install_prereq inference-operators 15m
                install_prereq inference-infrastructure 15m
                ;;
              *)
                echo "Unknown prerequisite: $prereq"
                ;;
            esac
          done

      - name: Build chart dependencies
        run: helm dependency build charts/${{ matrix.chart }}

      - name: Install chart
        run: |
          # Use CI values file if it exists
          VALUES_ARGS=""
          if [[ -f "charts/${{ matrix.chart }}/ci/default-values.yaml" ]]; then
            VALUES_ARGS="-f charts/${{ matrix.chart }}/ci/default-values.yaml"
            echo "Using CI values file: charts/${{ matrix.chart }}/ci/default-values.yaml"
          fi

          # Per-chart timeout from annotation, default 15m
          TIMEOUT=$(yq -r '.annotations["testing/timeout"] // "15m"' "charts/${{ matrix.chart }}/Chart.yaml")
          echo "Install timeout: $TIMEOUT"

          helm install ${{ matrix.chart }} charts/${{ matrix.chart }} \
            $VALUES_ARGS \
            --namespace default \
            --wait \
            --timeout "$TIMEOUT"

      - name: Verify resources
        run: |
          echo "Verifying resources for ${{ matrix.chart }}..."
          kubectl get all -n default -l app.kubernetes.io/instance=${{ matrix.chart }} || true

      - name: Run helm test
        run: helm test ${{ matrix.chart }} --namespace default
