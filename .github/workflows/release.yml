name: Release Charts

on:
  push:
    branches:
      - master

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Install chart-releaser
        run: |
          curl -sSLo cr.tar.gz https://github.com/helm/chart-releaser/releases/download/v1.6.1/chart-releaser_1.6.1_linux_amd64.tar.gz
          tar -xzf cr.tar.gz
          sudo mv cr /usr/local/bin/cr

      - name: Install helm-docs
        run: |
          curl -sSLo helm-docs.tar.gz https://github.com/norwoodj/helm-docs/releases/download/v1.14.2/helm-docs_1.14.2_Linux_x86_64.tar.gz
          tar -xzf helm-docs.tar.gz
          sudo mv helm-docs /usr/local/bin/helm-docs

      - name: Add helm repo for dependencies
        run: |
          helm repo add self https://${{ github.repository_owner }}.github.io/$(basename ${{ github.repository }})/
          helm repo update

      - name: Process charts
        id: process
        run: |
          mkdir -p .cr-release-packages
          failed_charts=""
          released_charts=""
          skipped_charts=""

          for chart_dir in charts/*/; do
            chart_name=$(basename "$chart_dir")

            # Skip if no Chart.yaml
            if [[ ! -f "${chart_dir}Chart.yaml" ]]; then
              echo "Skipping $chart_name: no Chart.yaml"
              continue
            fi

            # Get chart version
            chart_version=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}' | tr -d '"')
            release_tag="${chart_name}-${chart_version}"

            echo "::group::Processing $chart_name ($chart_version)"

            # Check if already released (tag exists)
            if git tag -l "$release_tag" | grep -q "$release_tag"; then
              echo "Skipping $chart_name: $release_tag already released"
              skipped_charts="$skipped_charts $chart_name"
              echo "::endgroup::"
              continue
            fi

            # Run helm-docs if template exists
            if [[ -f "${chart_dir}README.md.gotmpl" ]]; then
              echo "Running helm-docs for $chart_name..."
              helm-docs --chart-search-root="$chart_dir"
            fi

            # Try to update dependencies
            if ! helm dependency update "$chart_dir" 2>&1; then
              echo "::warning::Dependency update failed for $chart_name"
              failed_charts="$failed_charts $chart_name"
              echo "::endgroup::"
              continue
            fi

            # Package the chart
            if helm package "$chart_dir" -d .cr-release-packages 2>&1; then
              echo "Successfully packaged $chart_name"
              released_charts="$released_charts $chart_name"
            else
              echo "::warning::Failed to package $chart_name"
              failed_charts="$failed_charts $chart_name"
            fi

            echo "::endgroup::"
          done

          echo "released=$released_charts" >> $GITHUB_OUTPUT
          echo "failed=$failed_charts" >> $GITHUB_OUTPUT
          echo "skipped=$skipped_charts" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Summary ==="
          echo "Released: $released_charts"
          echo "Skipped (already released): $skipped_charts"
          echo "Failed: $failed_charts"

      - name: Commit documentation updates
        run: |
          if [[ -n "$(git status --porcelain charts/*/README.md)" ]]; then
            git add charts/*/README.md
            git commit -m "docs: update values documentation"
            git push
          else
            echo "No documentation changes to commit"
          fi

      - name: Upload charts
        if: steps.process.outputs.released != ''
        run: |
          if ls .cr-release-packages/*.tgz 1>/dev/null 2>&1; then
            cr upload \
              --owner "${{ github.repository_owner }}" \
              --git-repo "$(basename ${{ github.repository }})" \
              --token "${{ secrets.GITHUB_TOKEN }}" \
              --skip-existing
          fi
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Update chart index
        if: steps.process.outputs.released != ''
        run: |
          if ls .cr-release-packages/*.tgz 1>/dev/null 2>&1; then
            owner="${{ github.repository_owner }}"
            repo="$(basename ${{ github.repository }})"

            # Checkout gh-pages branch
            git fetch origin gh-pages
            git worktree add gh-pages-branch origin/gh-pages

            # Copy existing index as base for merge
            cp gh-pages-branch/index.yaml .cr-release-packages/index.yaml 2>/dev/null || true

            # Generate updated index, merging new charts with existing
            helm repo index .cr-release-packages \
              --url "https://github.com/${owner}/${repo}/releases/download" \
              --merge .cr-release-packages/index.yaml 2>/dev/null || \
            helm repo index .cr-release-packages \
              --url "https://github.com/${owner}/${repo}/releases/download"

            # Fix URLs to point to correct release assets
            # helm repo index generates URLs like /releases/download/chart-0.1.0.tgz
            # but GitHub releases need /releases/download/<tag>/chart-0.1.0.tgz
            for tgz in .cr-release-packages/*.tgz; do
              filename=$(basename "$tgz")
              chart_name=$(echo "$filename" | sed 's/-[0-9].*//')
              version=$(echo "$filename" | sed "s/${chart_name}-//" | sed 's/.tgz//')
              tag="${chart_name}-${version}"
              # Update URL in index.yaml
              sed -i "s|releases/download/${filename}|releases/download/${tag}/${filename}|g" .cr-release-packages/index.yaml
            done

            # Copy updated index to gh-pages branch
            cp .cr-release-packages/index.yaml gh-pages-branch/index.yaml

            # Commit and push
            cd gh-pages-branch
            git add index.yaml
            git commit -m "Update index.yaml with new charts" || echo "No changes to commit"
            git push origin HEAD:gh-pages

            cd ..
            git worktree remove gh-pages-branch
          fi

      - name: Report status
        if: always()
        run: |
          failed="${{ steps.process.outputs.failed }}"
          released="${{ steps.process.outputs.released }}"
          skipped="${{ steps.process.outputs.skipped }}"

          echo "=== Final Report ==="
          echo "Released:$released"
          echo "Skipped:$skipped"
          echo "Failed:$failed"

          if [[ -n "$failed" ]]; then
            echo ""
            echo "::error::The following charts failed to release:$failed"
            echo ""
            echo "This may be expected for umbrella charts on first run."
            echo "Re-run this workflow after dependencies are published."
            exit 1
          fi
